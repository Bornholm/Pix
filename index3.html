<!DOCTYPE html> 
<html lang="en"> 
	<head> 
		<meta charset="utf-8" /> 
		<title>Pix</title>  
		<link rel="stylesheet" href="css/main.css" type="text/css" />
	</head>  
	<body id="index" class="home">
		<div>
			
			<label>Zoom</label>
			<select id="zoom">
			</select>
			<button id="saveButton">Enregistrer</button>
		</div>
		<div class="container">
			<canvas id="preview"></canvas>
		</div>
		<canvas id="workspace"></canvas>
		
		<script type="text/javascript" src="libs/zepto.min.js"></script>
		<script type="text/javascript">
			$(function(){

				"use strict";

				var wrapper,
					workspace = document.getElementById('workspace'),
					wsContext = workspace.getContext('2d'),
					preview = document.getElementById('preview'),
					pvContext = preview.getContext('2d'),
					width = 128,
					height = 128,
					scale = 1,
					isDrawing = false;

				workspace.width = preview.width = width;
				workspace.height = preview.height = height;

				workspace.width *= scale;
				workspace.height *= scale;

				$(workspace).mousedown( function() {
					isDrawing = true;
				});

				$(workspace).mouseup( function() {
					isDrawing = false;
				});

				$(workspace).mousemove(function(evt) {
					//console.log(evt);
					var coords = getCanvasCoordinates(evt, workspace),
						x = Math.floor(coords.x/scale),
						y = Math.floor(coords.y/scale);

					if( isDrawing ) {
						wsContext.fillStyle = "black";
						wsContext.fillRect( x*scale, y*scale, scale, scale);
						pvContext.fillRect( x, y, 1, 1);
					}

				});

				$(workspace).click(function(evt) {
					
					var coords = getCanvasCoordinates(evt, workspace),
						x = Math.floor(coords.x/scale),
						y = Math.floor(coords.y/scale);

					wsContext.fillRect( x*scale, y*scale, scale, scale);
					pvContext.fillRect( x, y, 1, 1);

				});

				function getCanvasCoordinates( mouseEvent, canvas ) {
					var coords = {};
					if (mouseEvent.pageX || mouseEvent.pageY) { 
					  coords.x = mouseEvent.pageX;
					  coords.y = mouseEvent.pageY;
					} else { 
					  coords.x = mouseEvent.clientX + document.body.scrollLeft + document.documentElement.scrollLeft; 
					  coords.y = mouseEvent.clientY + document.body.scrollTop + document.documentElement.scrollTop; 
					} 
					coords.x -= canvas.offsetLeft;
					coords.y -= canvas.offsetTop;
					return coords;
				};

				// Controls Handlers

				$("#saveButton").click(function() {
					var dataUrl = preview.toDataURL("image/png");
					window.open(dataUrl);
				});

				$("#zoom").change(function() {
					var i, j, imageData,
						r, g, b, a;
					
					scale = +$(this).val();

					wsContext.clearRect(0, 0, workspace.width, workspace.height);
					workspace.width = width*scale;
					workspace.height = height*scale;

					imageData = pvContext.getImageData(0, 0, width, height).data;
					for(i = 0; i < width; ++i) {
						for(j = 0; j < height; ++j) {
							r = imageData[((j*(width*4)) + (i*4))    ];
							g = imageData[((j*(width*4)) + (i*4)) + 1];
							b = imageData[((j*(width*4)) + (i*4)) + 2];
							a = imageData[((j*(width*4)) + (i*4)) + 3];
							wsContext.fillStyle = 'rgba('+r+','+g+','+b+','+a+')';
							wsContext.fillRect( i*scale, j*scale, scale, scale);
						}
					}

				});

				var count = 11;
				while(--count) {
					$('#zoom').append('<option value="'+count+'" '+ (count === 4 ? 'selected' : '') +' >'+count*100+'%</option>');
				}

				$("#zoom").trigger("change");

			});
		</script>
	</body> 
</html>